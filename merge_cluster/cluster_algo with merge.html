<!DOCTYPE html>

<html lang="en">

<head>
  <meta charset="utf-8" />
  <meta content="width=device-width, initial-scale=1.0" name="viewport" />
  <title>cluster_algo with merge</title>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/require.js/2.1.10/require.min.js"></script>

  <!-- Load mathjax -->
  <script src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.7/latest.js?config=TeX-AMS_CHTML-full,Safe"> </script>
  <!-- MathJax configuration -->
  <script type="text/x-mathjax-config">
    init_mathjax = function() {
        if (window.MathJax) {
        // MathJax loaded
            MathJax.Hub.Config({
                TeX: {
                    equationNumbers: {
                    autoNumber: "AMS",
                    useLabelIds: true
                    }
                },
                tex2jax: {
                    inlineMath: [ ['$','$'], ["\\(","\\)"] ],
                    displayMath: [ ['$$','$$'], ["\\[","\\]"] ],
                    processEscapes: true,
                    processEnvironments: true
                },
                displayAlign: 'center',
                messageStyle: 'none',
                CommonHTML: {
                    linebreaks: {
                    automatic: true
                    }
                }
            });

            MathJax.Hub.Queue(["Typeset", MathJax.Hub]);
        }
    }
    init_mathjax();
    </script>
  <!-- End of mathjax configuration -->
  <script type="module">
    document.addEventListener("DOMContentLoaded", async () => {
      const diagrams = document.querySelectorAll(".jp-Mermaid > pre.mermaid");
      // do not load mermaidjs if not needed
      if (!diagrams.length) {
        return;
      }
      const mermaid = (await import("https://cdnjs.cloudflare.com/ajax/libs/mermaid/10.7.0/mermaid.esm.min.mjs")).default;
      const parser = new DOMParser();

      mermaid.initialize({
        maxTextSize: 100000,
        maxEdges: 100000,
        startOnLoad: false,
        fontFamily: window
          .getComputedStyle(document.body)
          .getPropertyValue("--jp-ui-font-family"),
        theme: document.querySelector("body[data-jp-theme-light='true']")
          ? "default"
          : "dark",
      });

      let _nextMermaidId = 0;

      function makeMermaidImage(svg) {
        const img = document.createElement("img");
        const doc = parser.parseFromString(svg, "image/svg+xml");
        const svgEl = doc.querySelector("svg");
        const { maxWidth } = svgEl?.style || {};
        const firstTitle = doc.querySelector("title");
        const firstDesc = doc.querySelector("desc");

        img.setAttribute("src", `data:image/svg+xml,${encodeURIComponent(svg)}`);
        if (maxWidth) {
          img.width = parseInt(maxWidth);
        }
        if (firstTitle) {
          img.setAttribute("alt", firstTitle.textContent);
        }
        if (firstDesc) {
          const caption = document.createElement("figcaption");
          caption.className = "sr-only";
          caption.textContent = firstDesc.textContent;
          return [img, caption];
        }
        return [img];
      }

      async function makeMermaidError(text) {
        let errorMessage = "";
        try {
          await mermaid.parse(text);
        } catch (err) {
          errorMessage = `${err}`;
        }

        const result = document.createElement("details");
        result.className = 'jp-RenderedMermaid-Details';
        const summary = document.createElement("summary");
        summary.className = 'jp-RenderedMermaid-Summary';
        const pre = document.createElement("pre");
        const code = document.createElement("code");
        code.innerText = text;
        pre.appendChild(code);
        summary.appendChild(pre);
        result.appendChild(summary);

        const warning = document.createElement("pre");
        warning.innerText = errorMessage;
        result.appendChild(warning);
        return [result];
      }

      async function renderOneMarmaid(src) {
        const id = `jp-mermaid-${_nextMermaidId++}`;
        const parent = src.parentNode;
        let raw = src.textContent.trim();
        const el = document.createElement("div");
        el.style.visibility = "hidden";
        document.body.appendChild(el);
        let results = null;
        let output = null;
        try {
          let { svg } = await mermaid.render(id, raw, el);
          svg = cleanMermaidSvg(svg);
          results = makeMermaidImage(svg);
          output = document.createElement("figure");
          results.map(output.appendChild, output);
        } catch (err) {
          parent.classList.add("jp-mod-warning");
          results = await makeMermaidError(raw);
          output = results[0];
        } finally {
          el.remove();
        }
        parent.classList.add("jp-RenderedMermaid");
        parent.appendChild(output);
      }


      /**
       * Post-process to ensure mermaid diagrams contain only valid SVG and XHTML.
       */
      function cleanMermaidSvg(svg) {
        return svg.replace(RE_VOID_ELEMENT, replaceVoidElement);
      }


      /**
       * A regular expression for all void elements, which may include attributes and
       * a slash.
       *
       * @see https://developer.mozilla.org/en-US/docs/Glossary/Void_element
       *
       * Of these, only `<br>` is generated by Mermaid in place of `\n`,
       * but _any_ "malformed" tag will break the SVG rendering entirely.
       */
      const RE_VOID_ELEMENT =
        /<\s*(area|base|br|col|embed|hr|img|input|link|meta|param|source|track|wbr)\s*([^>]*?)\s*>/gi;

      /**
       * Ensure a void element is closed with a slash, preserving any attributes.
       */
      function replaceVoidElement(match, tag, rest) {
        rest = rest.trim();
        if (!rest.endsWith('/')) {
          rest = `${rest} /`;
        }
        return `<${tag} ${rest}>`;
      }

      void Promise.all([...diagrams].map(renderOneMarmaid));
    });
  </script>
  <style>
    .jp-Mermaid:not(.jp-RenderedMermaid) {
      display: none;
    }

    .jp-RenderedMermaid {
      overflow: auto;
      display: flex;
    }

    .jp-RenderedMermaid.jp-mod-warning {
      width: auto;
      padding: 0.5em;
      margin-top: 0.5em;
      border: var(--jp-border-width) solid var(--jp-warn-color2);
      border-radius: var(--jp-border-radius);
      color: var(--jp-ui-font-color1);
      font-size: var(--jp-ui-font-size1);
      white-space: pre-wrap;
      word-wrap: break-word;
    }

    .jp-RenderedMermaid figure {
      margin: 0;
      overflow: auto;
      max-width: 100%;
    }

    .jp-RenderedMermaid img {
      max-width: 100%;
    }

    .jp-RenderedMermaid-Details>pre {
      margin-top: 1em;
    }

    .jp-RenderedMermaid-Summary {
      color: var(--jp-warn-color2);
    }

    .jp-RenderedMermaid:not(.jp-mod-warning) pre {
      display: none;
    }

    .jp-RenderedMermaid-Summary>pre {
      display: inline-block;
      white-space: normal;
    }
  </style>
  <!-- End of mermaid configuration -->
</head>

<body class="jp-Notebook" data-jp-theme-light="true" data-jp-theme-name="JupyterLab Light">
  <main>
    <div class="jp-Cell jp-CodeCell jp-Notebook-cell jp-mod-noOutputs" id="cell-id=44d3863e">
      <div class="jp-Cell-inputWrapper" tabindex="0">
        <div class="jp-Collapser jp-InputCollapser jp-Cell-inputCollapser">
        </div>
        <div class="jp-InputArea jp-Cell-inputArea">
          <div class="jp-InputPrompt jp-InputArea-prompt">In [3]:</div>
          <div class="jp-CodeMirrorEditor jp-Editor jp-InputArea-editor" data-type="inline">
            <div class="cm-editor cm-s-jupyter">
              <div class="highlight hl-ipython3">
                <pre><span></span><span class="kn">import</span><span class="w"> </span><span class="nn">numpy</span><span class="w"> </span><span class="k">as</span><span class="w"> </span><span class="nn">np</span>
<span class="kn">import</span><span class="w"> </span><span class="nn">pandas</span><span class="w"> </span><span class="k">as</span><span class="w"> </span><span class="nn">pd</span>
</pre>
              </div>
            </div>
          </div>
        </div>
      </div>
    </div>
    <div class="jp-Cell jp-CodeCell jp-Notebook-cell" id="cell-id=081417d7">
      <div class="jp-Cell-inputWrapper" tabindex="0">
        <div class="jp-Collapser jp-InputCollapser jp-Cell-inputCollapser">
        </div>
        <div class="jp-InputArea jp-Cell-inputArea">
          <div class="jp-InputPrompt jp-InputArea-prompt">In [4]:</div>
          <div class="jp-CodeMirrorEditor jp-Editor jp-InputArea-editor" data-type="inline">
            <div class="cm-editor cm-s-jupyter">
              <div class="highlight hl-ipython3">
                <pre><span></span><span class="c1"># If your file is named like this:</span>

<span class="n">data</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">read_csv</span><span class="p">(</span><span class="s2">"../data/vpufs_reduced_features.csv"</span><span class="p">)</span>

<span class="n">data</span> <span class="o">=</span> <span class="n">data</span><span class="o">.</span><span class="n">dropna</span><span class="p">(</span><span class="n">axis</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>
<span class="n">data</span> <span class="o">=</span> <span class="n">data</span><span class="o">.</span><span class="n">loc</span><span class="p">[:,</span> <span class="o">~</span><span class="n">data</span><span class="o">.</span><span class="n">columns</span><span class="o">.</span><span class="n">duplicated</span><span class="p">()]</span>
<span class="n">data</span> <span class="o">=</span> <span class="n">data</span><span class="o">.</span><span class="n">apply</span><span class="p">(</span><span class="n">pd</span><span class="o">.</span><span class="n">to_numeric</span><span class="p">,</span> <span class="n">errors</span><span class="o">=</span><span class="s1">'coerce'</span><span class="p">)</span>
<span class="n">data</span> <span class="o">=</span> <span class="n">data</span><span class="o">.</span><span class="n">dropna</span><span class="p">()</span>

<span class="c1"># 3. Extract features and labels</span>
<span class="n">labels</span> <span class="o">=</span> <span class="n">data</span><span class="o">.</span><span class="n">iloc</span><span class="p">[:,</span> <span class="o">-</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">values</span>
<span class="n">features_df</span> <span class="o">=</span> <span class="n">data</span><span class="o">.</span><span class="n">drop</span><span class="p">(</span><span class="n">data</span><span class="o">.</span><span class="n">columns</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">],</span> <span class="n">axis</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>


<span class="nb">print</span><span class="p">(</span><span class="n">data</span><span class="o">.</span><span class="n">shape</span><span class="p">)</span>

<span class="nb">print</span><span class="p">(</span><span class="n">data</span><span class="o">.</span><span class="n">head</span><span class="p">())</span>
</pre>
              </div>
            </div>
          </div>
        </div>
      </div>
      <div class="jp-Cell-outputWrapper">
        <div class="jp-Collapser jp-OutputCollapser jp-Cell-outputCollapser">
        </div>
        <div class="jp-OutputArea jp-Cell-outputArea">
          <div class="jp-OutputArea-child">
            <div class="jp-OutputPrompt jp-OutputArea-prompt"></div>
            <div class="jp-RenderedText jp-OutputArea-output" data-mime-type="text/plain" tabindex="0">
              <pre>(624, 1000)
    586        384    87    751    81       262   697   581   364   383  ...  \
0  52.5  29.600000  65.4  11.20  22.5  3.580000  15.3  21.8  2.95  25.1  ...   
1  63.6  42.800000  68.7  12.00  27.3  4.620000  20.2  27.7  3.27  31.9  ...   
2  47.6   1.505021  75.8  10.20  32.6  3.310000  16.2  20.5  5.22  28.8  ...   
3  59.2  40.100000  62.1  14.00  27.2  3.300000  18.9  30.9  5.48  26.5  ...   
4  40.9  37.500000  74.7   4.61  32.9  1.510252  16.9  24.3  1.56  30.0  ...   

     884   634    29   172   263    45   741   378        906    840  
0  3.050  14.3  5.92  6.76  11.3  13.6  1.99  64.1  32.300000  12.70  
1  1.660  18.3  6.83  8.31  15.7  20.9  2.31  47.6  30.400000   8.12  
2  0.625  15.6  9.65  7.63  15.8  19.2  1.86  43.5  23.800000   8.85  
3  3.580  16.1  7.15  6.30  11.3  19.6  2.15  54.8  31.100000  10.80  
4  1.170  15.9  9.72  5.24  14.4  18.5  2.15  42.1   1.510252   9.81  

[5 rows x 1000 columns]
</pre>
            </div>
          </div>
        </div>
      </div>
    </div>
    <div class="jp-Cell jp-CodeCell jp-Notebook-cell jp-mod-noOutputs" id="cell-id=1c7abfc8">
      <div class="jp-Cell-inputWrapper" tabindex="0">
        <div class="jp-Collapser jp-InputCollapser jp-Cell-inputCollapser">
        </div>
        <div class="jp-InputArea jp-Cell-inputArea">
          <div class="jp-InputPrompt jp-InputArea-prompt">In [5]:</div>
          <div class="jp-CodeMirrorEditor jp-Editor jp-InputArea-editor" data-type="inline">
            <div class="cm-editor cm-s-jupyter">
              <div class="highlight hl-ipython3">
                <pre><span></span><span class="kn">import</span><span class="w"> </span><span class="nn">numpy</span><span class="w"> </span><span class="k">as</span><span class="w"> </span><span class="nn">np</span>
<span class="kn">import</span><span class="w"> </span><span class="nn">pandas</span><span class="w"> </span><span class="k">as</span><span class="w"> </span><span class="nn">pd</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">sklearn.feature_selection</span><span class="w"> </span><span class="kn">import</span> <span class="n">SelectKBest</span><span class="p">,</span> <span class="n">f_classif</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">sklearn.preprocessing</span><span class="w"> </span><span class="kn">import</span> <span class="n">StandardScaler</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">scipy.spatial.distance</span><span class="w"> </span><span class="kn">import</span> <span class="n">cdist</span>

<span class="c1"># def reduce_features(X, y=None, k=1000):</span>
<span class="c1">#     """ Reduce gene expression matrix to top k features """</span>
<span class="c1">#     if y is None:</span>
<span class="c1">#         # Use variance threshold if labels are not present</span>
<span class="c1">#         from sklearn.feature_selection import VarianceThreshold</span>
<span class="c1">#         selector = VarianceThreshold(threshold=0.01)</span>
<span class="c1">#         X_new = selector.fit_transform(X)</span>
<span class="c1">#         if X_new.shape[1] &gt; k:</span>
<span class="c1">#             X_new = X_new[:, :k]</span>
<span class="c1">#         return X_new</span>
<span class="c1">#     else:</span>
<span class="c1">#         selector = SelectKBest(score_func=f_classif, k=k)</span>
<span class="c1">#         X_new = selector.fit_transform(X, y)</span>
<span class="c1">#         return X_new</span>

<span class="k">def</span><span class="w"> </span><span class="nf">normalized_euclidean_similarity</span><span class="p">(</span><span class="n">X</span><span class="p">):</span>
<span class="w">    </span><span class="sd">""" Compute (1 - normalized Euclidean distance) similarity matrix """</span>
    <span class="c1"># Normalize data</span>
    <span class="n">scaler</span> <span class="o">=</span> <span class="n">StandardScaler</span><span class="p">()</span>
    <span class="n">X_scaled</span> <span class="o">=</span> <span class="n">scaler</span><span class="o">.</span><span class="n">fit_transform</span><span class="p">(</span><span class="n">X</span><span class="p">)</span>
    
    <span class="c1"># Euclidean distances</span>
    <span class="n">distances</span> <span class="o">=</span> <span class="n">cdist</span><span class="p">(</span><span class="n">X_scaled</span><span class="p">,</span> <span class="n">X_scaled</span><span class="p">,</span> <span class="n">metric</span><span class="o">=</span><span class="s1">'euclidean'</span><span class="p">)</span>
    
    <span class="c1"># Normalize distances to [0, 1]</span>
    <span class="n">max_dist</span> <span class="o">=</span> <span class="n">distances</span><span class="o">.</span><span class="n">max</span><span class="p">()</span>
    <span class="n">normalized_dist</span> <span class="o">=</span> <span class="n">distances</span> <span class="o">/</span> <span class="n">max_dist</span>
    
    <span class="c1"># Convert to similarity</span>
    <span class="n">similarity</span> <span class="o">=</span> <span class="mi">1</span> <span class="o">-</span> <span class="n">normalized_dist</span>
    <span class="k">return</span> <span class="n">similarity</span>

<span class="k">def</span><span class="w"> </span><span class="nf">build_clusters</span><span class="p">(</span><span class="n">similarity_matrix</span><span class="p">,</span> <span class="n">r</span><span class="o">=</span><span class="mf">0.9</span><span class="p">):</span>
<span class="w">    </span><span class="sd">""" Identify neighbors based on similarity threshold and count densities """</span>
    <span class="n">n_samples</span> <span class="o">=</span> <span class="n">similarity_matrix</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
    <span class="n">clusters</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="n">densities</span> <span class="o">=</span> <span class="p">[]</span>
    
    <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">n_samples</span><span class="p">):</span>
        <span class="n">neighbors</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">where</span><span class="p">(</span><span class="n">similarity_matrix</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">&gt;=</span> <span class="n">r</span><span class="p">)[</span><span class="mi">0</span><span class="p">]</span>
        <span class="n">clusters</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">neighbors</span><span class="p">)</span>
        <span class="n">densities</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">neighbors</span><span class="p">))</span>
    
    <span class="k">return</span> <span class="n">clusters</span><span class="p">,</span> <span class="n">densities</span>



<span class="k">def</span><span class="w"> </span><span class="nf">run_pipeline</span><span class="p">(</span><span class="n">data</span><span class="p">:</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">,</span> <span class="n">labels</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">k</span><span class="o">=</span><span class="mi">1000</span><span class="p">,</span> <span class="n">r</span><span class="o">=</span><span class="mf">0.9</span><span class="p">):</span>
    <span class="c1"># print("Step 1: Reducing features...")</span>
    <span class="c1"># reduced_data = reduce_features(data.values, y=labels, k=k)</span>
    <span class="c1"># print(f"Reduced shape: {reduced_data.shape}")</span>
    
    <span class="nb">print</span><span class="p">(</span><span class="s2">"Step 2: Computing similarity matrix..."</span><span class="p">)</span>
    <span class="n">similarity</span> <span class="o">=</span> <span class="n">normalized_euclidean_similarity</span><span class="p">(</span><span class="n">data</span><span class="p">)</span>
    
    <span class="nb">print</span><span class="p">(</span><span class="s2">"Step 3: Identifying neighbors and densities..."</span><span class="p">)</span>
    <span class="n">clusters</span><span class="p">,</span> <span class="n">densities</span> <span class="o">=</span> <span class="n">build_clusters</span><span class="p">(</span><span class="n">similarity</span><span class="p">,</span> <span class="n">r</span><span class="o">=</span><span class="n">r</span><span class="p">)</span>
    
    <span class="k">return</span> <span class="n">clusters</span><span class="p">,</span> <span class="n">densities</span><span class="p">,</span> <span class="n">similarity</span>
</pre>
              </div>
            </div>
          </div>
        </div>
      </div>
    </div>
    <div class="jp-Cell jp-CodeCell jp-Notebook-cell" id="cell-id=3ba83c4d">
      <div class="jp-Cell-inputWrapper" tabindex="0">
        <div class="jp-Collapser jp-InputCollapser jp-Cell-inputCollapser">
        </div>
        <div class="jp-InputArea jp-Cell-inputArea">
          <div class="jp-InputPrompt jp-InputArea-prompt">In [ ]:</div>
          <div class="jp-CodeMirrorEditor jp-Editor jp-InputArea-editor" data-type="inline">
            <div class="cm-editor cm-s-jupyter">
              <div class="highlight hl-ipython3">
                <pre><span></span><span class="n">clusters</span><span class="p">,</span> <span class="n">densities</span><span class="p">,</span> <span class="n">similarity</span> <span class="o">=</span> <span class="n">run_pipeline</span><span class="p">(</span><span class="n">features_df</span><span class="p">,</span> <span class="n">labels</span><span class="o">=</span><span class="n">labels</span><span class="p">,</span> <span class="n">k</span><span class="o">=</span><span class="mi">1000</span><span class="p">,</span> <span class="n">r</span><span class="o">=</span><span class="mf">0.862</span><span class="p">)</span>



<span class="c1"># Combine index, density, and cluster info into a list of tuples</span>
<span class="n">sample_info</span> <span class="o">=</span> <span class="p">[(</span><span class="n">i</span><span class="p">,</span> <span class="n">densities</span><span class="p">[</span><span class="n">i</span><span class="p">],</span> <span class="n">clusters</span><span class="p">[</span><span class="n">i</span><span class="p">])</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">clusters</span><span class="p">))]</span>

<span class="c1"># Now sort that list by density (2nd item in tuple) in descending order</span>
<span class="n">sample_info_sorted</span> <span class="o">=</span> <span class="nb">sorted</span><span class="p">(</span><span class="n">sample_info</span><span class="p">,</span> <span class="n">key</span><span class="o">=</span><span class="k">lambda</span> <span class="n">x</span><span class="p">:</span> <span class="n">x</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span> <span class="n">reverse</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>

<span class="c1"># Print sorted result</span>
<span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="n">density</span><span class="p">,</span> <span class="n">neighbors</span> <span class="ow">in</span> <span class="n">sample_info_sorted</span><span class="p">[:</span><span class="mi">50</span><span class="p">]:</span>
    <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">"Sample </span><span class="si">{</span><span class="n">i</span><span class="si">}</span><span class="s2">: Density = </span><span class="si">{</span><span class="n">density</span><span class="si">}</span><span class="s2">"</span><span class="p">)</span>
    <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">"Neighbors: </span><span class="si">{</span><span class="n">neighbors</span><span class="si">}</span><span class="s2">"</span><span class="p">)</span>
    <span class="nb">print</span><span class="p">(</span><span class="s2">"-----------"</span><span class="p">)</span>
    <span class="nb">print</span><span class="p">()</span>
</pre>
              </div>
            </div>
          </div>
        </div>
      </div>
      <div class="jp-Cell-outputWrapper">
        <div class="jp-Collapser jp-OutputCollapser jp-Cell-outputCollapser">
        </div>
        <div class="jp-OutputArea jp-Cell-outputArea">
          <div class="jp-OutputArea-child">
            <div class="jp-OutputPrompt jp-OutputArea-prompt"></div>
            <div class="jp-RenderedText jp-OutputArea-output" data-mime-type="text/plain" tabindex="0">
              <pre>Step 2: Computing similarity matrix...
Step 3: Identifying neighbors and densities...
Sample 465: Density = 7
Neighbors: [443 454 460 461 464 465 466]
-----------

Sample 466: Density = 7
Neighbors: [443 450 451 454 461 465 466]
-----------

Sample 536: Density = 6
Neighbors: [490 498 503 525 536 538]
-----------

Sample 426: Density = 5
Neighbors: [316 347 409 421 426]
-----------

Sample 461: Density = 5
Neighbors: [443 461 462 465 466]
-----------

Sample 2: Density = 4
Neighbors: [  2 316 322 409]
-----------

Sample 322: Density = 4
Neighbors: [  2 322 338 413]
-----------

Sample 409: Density = 4
Neighbors: [  2 409 413 426]
-----------

Sample 443: Density = 4
Neighbors: [443 461 465 466]
-----------

Sample 490: Density = 4
Neighbors: [490 525 536 538]
-----------

Sample 498: Density = 4
Neighbors: [498 505 536 552]
-----------

Sample 505: Density = 4
Neighbors: [442 498 505 538]
-----------

Sample 538: Density = 4
Neighbors: [490 505 536 538]
-----------

Sample 286: Density = 3
Neighbors: [286 287 289]
-----------

Sample 287: Density = 3
Neighbors: [286 287 293]
-----------

Sample 316: Density = 3
Neighbors: [  2 316 426]
-----------

Sample 338: Density = 3
Neighbors: [322 338 376]
-----------

Sample 413: Density = 3
Neighbors: [322 409 413]
-----------

Sample 454: Density = 3
Neighbors: [454 465 466]
-----------

Sample 525: Density = 3
Neighbors: [490 525 536]
-----------

Sample 527: Density = 3
Neighbors: [527 552 556]
-----------

Sample 552: Density = 3
Neighbors: [498 527 552]
-----------

Sample 556: Density = 3
Neighbors: [172 527 556]
-----------

Sample 603: Density = 3
Neighbors: [597 600 603]
-----------

Sample 103: Density = 2
Neighbors: [103 139]
-----------

Sample 139: Density = 2
Neighbors: [103 139]
-----------

Sample 172: Density = 2
Neighbors: [172 556]
-----------

Sample 264: Density = 2
Neighbors: [264 269]
-----------

Sample 269: Density = 2
Neighbors: [264 269]
-----------

Sample 285: Density = 2
Neighbors: [285 288]
-----------

Sample 288: Density = 2
Neighbors: [285 288]
-----------

Sample 289: Density = 2
Neighbors: [286 289]
-----------

Sample 293: Density = 2
Neighbors: [287 293]
-----------

Sample 347: Density = 2
Neighbors: [347 426]
-----------

Sample 376: Density = 2
Neighbors: [338 376]
-----------

Sample 421: Density = 2
Neighbors: [421 426]
-----------

Sample 442: Density = 2
Neighbors: [442 505]
-----------

Sample 450: Density = 2
Neighbors: [450 466]
-----------

Sample 451: Density = 2
Neighbors: [451 466]
-----------

Sample 460: Density = 2
Neighbors: [460 465]
-----------

Sample 462: Density = 2
Neighbors: [461 462]
-----------

Sample 464: Density = 2
Neighbors: [464 465]
-----------

Sample 477: Density = 2
Neighbors: [477 551]
-----------

Sample 497: Density = 2
Neighbors: [497 550]
-----------

Sample 499: Density = 2
Neighbors: [499 533]
-----------

Sample 503: Density = 2
Neighbors: [503 536]
-----------

Sample 533: Density = 2
Neighbors: [499 533]
-----------

Sample 548: Density = 2
Neighbors: [548 563]
-----------

Sample 550: Density = 2
Neighbors: [497 550]
-----------

Sample 551: Density = 2
Neighbors: [477 551]
-----------

</pre>
            </div>
          </div>
        </div>
      </div>
    </div>
    <div class="jp-Cell jp-CodeCell jp-Notebook-cell jp-mod-noOutputs" id="cell-id=e4d13ecd">
      <div class="jp-Cell-inputWrapper" tabindex="0">
        <div class="jp-Collapser jp-InputCollapser jp-Cell-inputCollapser">
        </div>
        <div class="jp-InputArea jp-Cell-inputArea">
          <div class="jp-InputPrompt jp-InputArea-prompt">In [7]:</div>
          <div class="jp-CodeMirrorEditor jp-Editor jp-InputArea-editor" data-type="inline">
            <div class="cm-editor cm-s-jupyter">
              <div class="highlight hl-ipython3">
                <pre><span></span><span class="k">def</span><span class="w"> </span><span class="nf">merge_clusters</span><span class="p">(</span><span class="n">sample_info_sorted</span><span class="p">,</span> <span class="n">threshold</span><span class="o">=</span><span class="mf">0.5</span><span class="p">):</span>
<span class="w">    </span><span class="sd">"""</span>
<span class="sd">    Merge clusters if they share more than `threshold` of the total number of samples.</span>
<span class="sd">    The merging will be based on the ratio of common samples to the total distinct samples.</span>
<span class="sd">    """</span>
    <span class="n">merged</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="n">visited</span> <span class="o">=</span> <span class="nb">set</span><span class="p">()</span>

    <span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="n">density_i</span><span class="p">,</span> <span class="n">cluster_i</span> <span class="ow">in</span> <span class="n">sample_info_sorted</span><span class="p">:</span>
        <span class="k">if</span> <span class="n">i</span> <span class="ow">in</span> <span class="n">visited</span><span class="p">:</span>
            <span class="k">continue</span>

        <span class="c1"># Start new merged cluster</span>
        <span class="n">merged_cluster</span> <span class="o">=</span> <span class="nb">set</span><span class="p">(</span><span class="n">cluster_i</span><span class="p">)</span>
        <span class="n">merged_indices</span> <span class="o">=</span> <span class="p">{</span><span class="n">i</span><span class="p">}</span>
        <span class="n">visited</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="n">i</span><span class="p">)</span>

        <span class="n">changed</span> <span class="o">=</span> <span class="kc">True</span>
        <span class="k">while</span> <span class="n">changed</span><span class="p">:</span>
            <span class="n">changed</span> <span class="o">=</span> <span class="kc">False</span>
            <span class="k">for</span> <span class="n">j</span><span class="p">,</span> <span class="n">density_j</span><span class="p">,</span> <span class="n">cluster_j</span> <span class="ow">in</span> <span class="n">sample_info_sorted</span><span class="p">:</span>
                <span class="k">if</span> <span class="n">j</span> <span class="ow">in</span> <span class="n">visited</span><span class="p">:</span>
                    <span class="k">continue</span>

                <span class="n">set_j</span> <span class="o">=</span> <span class="nb">set</span><span class="p">(</span><span class="n">cluster_j</span><span class="p">)</span>
                <span class="n">common</span> <span class="o">=</span> <span class="n">merged_cluster</span><span class="o">.</span><span class="n">intersection</span><span class="p">(</span><span class="n">set_j</span><span class="p">)</span>  <span class="c1"># common samples</span>
                <span class="n">union</span> <span class="o">=</span> <span class="n">merged_cluster</span><span class="o">.</span><span class="n">union</span><span class="p">(</span><span class="n">set_j</span><span class="p">)</span>  <span class="c1"># total distinct samples</span>
                <span class="n">common_size</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">common</span><span class="p">)</span>
                <span class="n">union_size</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">union</span><span class="p">)</span>

                <span class="c1"># Calculate the ratio of common samples to total distinct samples</span>
                <span class="n">similarity_ratio</span> <span class="o">=</span> <span class="n">common_size</span> <span class="o">/</span> <span class="n">union_size</span> <span class="k">if</span> <span class="n">union_size</span> <span class="o">&gt;</span> <span class="mi">0</span> <span class="k">else</span> <span class="mi">0</span>

                <span class="c1"># Merge if similarity ratio exceeds threshold</span>
                <span class="k">if</span> <span class="n">similarity_ratio</span> <span class="o">&gt;</span> <span class="n">threshold</span><span class="p">:</span>
                    <span class="n">merged_cluster</span><span class="o">.</span><span class="n">update</span><span class="p">(</span><span class="n">set_j</span><span class="p">)</span>
                    <span class="n">visited</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="n">j</span><span class="p">)</span>
                    <span class="n">merged_indices</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="n">j</span><span class="p">)</span>
                    <span class="n">changed</span> <span class="o">=</span> <span class="kc">True</span>

        <span class="n">merged</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="nb">list</span><span class="p">(</span><span class="n">merged_cluster</span><span class="p">))</span>

    <span class="k">return</span> <span class="n">merged</span>
</pre>
              </div>
            </div>
          </div>
        </div>
      </div>
    </div>
    <div class="jp-Cell jp-CodeCell jp-Notebook-cell" id="cell-id=396b3870">
      <div class="jp-Cell-inputWrapper" tabindex="0">
        <div class="jp-Collapser jp-InputCollapser jp-Cell-inputCollapser">
        </div>
        <div class="jp-InputArea jp-Cell-inputArea">
          <div class="jp-InputPrompt jp-InputArea-prompt">In [8]:</div>
          <div class="jp-CodeMirrorEditor jp-Editor jp-InputArea-editor" data-type="inline">
            <div class="cm-editor cm-s-jupyter">
              <div class="highlight hl-ipython3">
                <pre><span></span><span class="c1"># Step 1: Sort by density (already done)</span>
<span class="n">sample_info</span> <span class="o">=</span> <span class="p">[(</span><span class="n">i</span><span class="p">,</span> <span class="n">densities</span><span class="p">[</span><span class="n">i</span><span class="p">],</span> <span class="n">clusters</span><span class="p">[</span><span class="n">i</span><span class="p">])</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">clusters</span><span class="p">))]</span>
<span class="n">sample_info_sorted</span> <span class="o">=</span> <span class="nb">sorted</span><span class="p">(</span><span class="n">sample_info</span><span class="p">,</span> <span class="n">key</span><span class="o">=</span><span class="k">lambda</span> <span class="n">x</span><span class="p">:</span> <span class="n">x</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span> <span class="n">reverse</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>

<span class="c1"># Step 2: Merge clusters based on &gt;50% overlap rule</span>
<span class="n">merged_clusters</span> <span class="o">=</span> <span class="n">merge_clusters</span><span class="p">(</span><span class="n">sample_info_sorted</span><span class="p">)</span>

<span class="c1"># Step 3: Print merged cluster summary</span>
<span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">"Total merged clusters: </span><span class="si">{</span><span class="nb">len</span><span class="p">(</span><span class="n">merged_clusters</span><span class="p">)</span><span class="si">}</span><span class="s2">"</span><span class="p">)</span>
<span class="k">for</span> <span class="n">idx</span><span class="p">,</span> <span class="n">cluster</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">merged_clusters</span><span class="p">):</span>
    <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">"Merged Cluster </span><span class="si">{</span><span class="n">idx</span><span class="o">+</span><span class="mi">1</span><span class="si">}</span><span class="s2">: Size = </span><span class="si">{</span><span class="nb">len</span><span class="p">(</span><span class="n">cluster</span><span class="p">)</span><span class="si">}</span><span class="s2"> Samples = </span><span class="si">{</span><span class="nb">sorted</span><span class="p">([</span><span class="nb">int</span><span class="p">(</span><span class="n">i</span><span class="p">)</span><span class="w"> </span><span class="k">for</span><span class="w"> </span><span class="n">i</span><span class="w"> </span><span class="ow">in</span><span class="w"> </span><span class="n">cluster</span><span class="p">])</span><span class="si">}</span><span class="s2">"</span><span class="p">)</span>
</pre>
              </div>
            </div>
          </div>
        </div>
      </div>
      <div class="jp-Cell-outputWrapper">
        <div class="jp-Collapser jp-OutputCollapser jp-Cell-outputCollapser">
        </div>
        <div class="jp-OutputArea jp-Cell-outputArea">
          <div class="jp-OutputArea-child">
            <div class="jp-OutputPrompt jp-OutputArea-prompt"></div>
            <div class="jp-RenderedText jp-OutputArea-output" data-mime-type="text/plain" tabindex="0">
              <pre>Total merged clusters: 607
Merged Cluster 1: Size = 9 Samples = [443, 450, 451, 454, 460, 461, 464, 465, 466]
Merged Cluster 2: Size = 6 Samples = [490, 498, 503, 525, 536, 538]
Merged Cluster 3: Size = 5 Samples = [316, 347, 409, 421, 426]
Merged Cluster 4: Size = 5 Samples = [443, 461, 462, 465, 466]
Merged Cluster 5: Size = 4 Samples = [2, 316, 322, 409]
Merged Cluster 6: Size = 4 Samples = [2, 322, 338, 413]
Merged Cluster 7: Size = 4 Samples = [2, 409, 413, 426]
Merged Cluster 8: Size = 4 Samples = [498, 505, 536, 552]
Merged Cluster 9: Size = 4 Samples = [442, 498, 505, 538]
Merged Cluster 10: Size = 4 Samples = [490, 505, 536, 538]
Merged Cluster 11: Size = 3 Samples = [286, 287, 289]
Merged Cluster 12: Size = 3 Samples = [286, 287, 293]
Merged Cluster 13: Size = 3 Samples = [2, 316, 426]
Merged Cluster 14: Size = 3 Samples = [322, 338, 376]
Merged Cluster 15: Size = 3 Samples = [322, 409, 413]
Merged Cluster 16: Size = 3 Samples = [454, 465, 466]
Merged Cluster 17: Size = 3 Samples = [490, 525, 536]
Merged Cluster 18: Size = 3 Samples = [527, 552, 556]
Merged Cluster 19: Size = 3 Samples = [498, 527, 552]
Merged Cluster 20: Size = 3 Samples = [172, 527, 556]
Merged Cluster 21: Size = 3 Samples = [597, 600, 603]
Merged Cluster 22: Size = 2 Samples = [103, 139]
Merged Cluster 23: Size = 2 Samples = [264, 269]
Merged Cluster 24: Size = 2 Samples = [285, 288]
Merged Cluster 25: Size = 2 Samples = [347, 426]
Merged Cluster 26: Size = 2 Samples = [421, 426]
Merged Cluster 27: Size = 2 Samples = [442, 505]
Merged Cluster 28: Size = 2 Samples = [450, 466]
Merged Cluster 29: Size = 2 Samples = [451, 466]
Merged Cluster 30: Size = 2 Samples = [460, 465]
Merged Cluster 31: Size = 2 Samples = [461, 462]
Merged Cluster 32: Size = 2 Samples = [464, 465]
Merged Cluster 33: Size = 2 Samples = [477, 551]
Merged Cluster 34: Size = 2 Samples = [497, 550]
Merged Cluster 35: Size = 2 Samples = [499, 533]
Merged Cluster 36: Size = 2 Samples = [503, 536]
Merged Cluster 37: Size = 2 Samples = [548, 563]
Merged Cluster 38: Size = 2 Samples = [568, 576]
Merged Cluster 39: Size = 1 Samples = [0]
Merged Cluster 40: Size = 1 Samples = [1]
Merged Cluster 41: Size = 1 Samples = [3]
Merged Cluster 42: Size = 1 Samples = [4]
Merged Cluster 43: Size = 1 Samples = [5]
Merged Cluster 44: Size = 1 Samples = [6]
Merged Cluster 45: Size = 1 Samples = [7]
Merged Cluster 46: Size = 1 Samples = [8]
Merged Cluster 47: Size = 1 Samples = [9]
Merged Cluster 48: Size = 1 Samples = [10]
Merged Cluster 49: Size = 1 Samples = [11]
Merged Cluster 50: Size = 1 Samples = [12]
Merged Cluster 51: Size = 1 Samples = [13]
Merged Cluster 52: Size = 1 Samples = [14]
Merged Cluster 53: Size = 1 Samples = [15]
Merged Cluster 54: Size = 1 Samples = [16]
Merged Cluster 55: Size = 1 Samples = [17]
Merged Cluster 56: Size = 1 Samples = [18]
Merged Cluster 57: Size = 1 Samples = [19]
Merged Cluster 58: Size = 1 Samples = [20]
Merged Cluster 59: Size = 1 Samples = [21]
Merged Cluster 60: Size = 1 Samples = [22]
Merged Cluster 61: Size = 1 Samples = [23]
Merged Cluster 62: Size = 1 Samples = [24]
Merged Cluster 63: Size = 1 Samples = [25]
Merged Cluster 64: Size = 1 Samples = [26]
Merged Cluster 65: Size = 1 Samples = [27]
Merged Cluster 66: Size = 1 Samples = [28]
Merged Cluster 67: Size = 1 Samples = [29]
Merged Cluster 68: Size = 1 Samples = [30]
Merged Cluster 69: Size = 1 Samples = [31]
Merged Cluster 70: Size = 1 Samples = [32]
Merged Cluster 71: Size = 1 Samples = [33]
Merged Cluster 72: Size = 1 Samples = [34]
Merged Cluster 73: Size = 1 Samples = [35]
Merged Cluster 74: Size = 1 Samples = [36]
Merged Cluster 75: Size = 1 Samples = [37]
Merged Cluster 76: Size = 1 Samples = [38]
Merged Cluster 77: Size = 1 Samples = [39]
Merged Cluster 78: Size = 1 Samples = [40]
Merged Cluster 79: Size = 1 Samples = [41]
Merged Cluster 80: Size = 1 Samples = [42]
Merged Cluster 81: Size = 1 Samples = [43]
Merged Cluster 82: Size = 1 Samples = [44]
Merged Cluster 83: Size = 1 Samples = [45]
Merged Cluster 84: Size = 1 Samples = [46]
Merged Cluster 85: Size = 1 Samples = [47]
Merged Cluster 86: Size = 1 Samples = [48]
Merged Cluster 87: Size = 1 Samples = [49]
Merged Cluster 88: Size = 1 Samples = [50]
Merged Cluster 89: Size = 1 Samples = [51]
Merged Cluster 90: Size = 1 Samples = [52]
Merged Cluster 91: Size = 1 Samples = [53]
Merged Cluster 92: Size = 1 Samples = [54]
Merged Cluster 93: Size = 1 Samples = [55]
Merged Cluster 94: Size = 1 Samples = [56]
Merged Cluster 95: Size = 1 Samples = [57]
Merged Cluster 96: Size = 1 Samples = [58]
Merged Cluster 97: Size = 1 Samples = [59]
Merged Cluster 98: Size = 1 Samples = [60]
Merged Cluster 99: Size = 1 Samples = [61]
Merged Cluster 100: Size = 1 Samples = [62]
Merged Cluster 101: Size = 1 Samples = [63]
Merged Cluster 102: Size = 1 Samples = [64]
Merged Cluster 103: Size = 1 Samples = [65]
Merged Cluster 104: Size = 1 Samples = [66]
Merged Cluster 105: Size = 1 Samples = [67]
Merged Cluster 106: Size = 1 Samples = [68]
Merged Cluster 107: Size = 1 Samples = [69]


</pre>
            </div>
          </div>
        </div>
      </div>
    </div>
    <div class="jp-Cell jp-MarkdownCell jp-Notebook-cell" id="cell-id=867c5961">
      <div class="jp-Cell-inputWrapper" tabindex="0">
        <div class="jp-Collapser jp-InputCollapser jp-Cell-inputCollapser">
        </div>
        <div class="jp-InputArea jp-Cell-inputArea">
          <div class="jp-InputPrompt jp-InputArea-prompt">
          </div>
          <div class="jp-RenderedHTMLCommon jp-RenderedMarkdown jp-MarkdownOutput" data-mime-type="text/markdown">
            <h1 id="Remove-Outliers">Remove Outliers<a class="anchor-link" href="#Remove-Outliers">¶</a></h1>
          </div>
        </div>
      </div>
    </div>
  </main>
</body>

</html>